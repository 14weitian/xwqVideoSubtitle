# 忘记密码功能 - 邮件配置指南

## 功能概述

忘记密码功能允许用户通过注册邮箱验证身份，重置密码。流程如下：
1. 用户输入注册邮箱
2. 系统发送6位验证码到邮箱（有效期10分钟）
3. 用户输入验证码和新密码
4. 验证通过后重置密码成功

---

## 📧 邮件服务配置

### 方式1：使用QQ邮箱（推荐）

#### 1.1 开启SMTP服务
1. 登录QQ邮箱网页版
2. 进入 **设置** → **账户**
3. 找到 **POP3/IMAP/SMTP/Exchange/CardDAV/CalDAV服务**
4. 开启 **POP3/SMTP服务** 或 **IMAP/SMTP服务**
5. 获取**授权码**（不是QQ密码！）

#### 1.2 配置application.yml

```yaml
spring:
  mail:
    host: smtp.qq.com
    port: 587
    username: your_email@qq.com  # 你的QQ邮箱
    password: your_auth_code     # 授权码（不是QQ密码）
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true
            required: true
    default-encoding: UTF-8
```

#### 1.3 或使用环境变量（推荐）

在 `.bash_profile` 或 `.zshrc` 中添加：

```bash
export MAIL_HOST=smtp.qq.com
export MAIL_PORT=587
export MAIL_USERNAME=your_email@qq.com
export MAIL_PASSWORD=your_auth_code
```

---

### 方式2：使用163邮箱

#### 2.1 开启SMTP服务
1. 登录163邮箱
2. 进入 **设置** → **POP3/SMTP/IMAP**
3. 开启 **SMTP服务**
4. 获取**授权密码**

#### 2.2 配置

```yaml
spring:
  mail:
    host: smtp.163.com
    port: 465
    username: your_email@163.com
    password: your_auth_password
    properties:
      mail:
        smtp:
          auth: true
          ssl:
            enable: true
```

---

### 方式3：使用Gmail

#### 3.1 开启两步验证和应用密码
1. 开启Google账号的两步验证
2. 生成应用专用密码
3. 使用应用密码作为邮件密码

#### 3.2 配置

```yaml
spring:
  mail:
    host: smtp.gmail.com
    port: 587
    username: your_email@gmail.com
    password: your_app_password
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true
```

---

## 🗄️ 数据库表结构

```sql
CREATE TABLE email_verification_codes (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    email VARCHAR(255) NOT NULL COMMENT '邮箱地址',
    code VARCHAR(10) NOT NULL COMMENT '验证码',
    type VARCHAR(50) NOT NULL COMMENT '验证码类型（PASSWORD_RESET）',
    status TINYINT DEFAULT 1 COMMENT '状态：1-未使用，2-已使用，0-已过期',
    expires_at DATETIME NOT NULL COMMENT '过期时间',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    INDEX idx_email_type (email, type),
    INDEX idx_expires_at (expires_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='邮箱验证码表';
```

---

## 🚀 测试步骤

### 1. 配置邮件服务
选择一种邮件服务，配置 `application.yml` 或环境变量

### 2. 重启后端
```bash
cd /Users/hewei/myProject/xwqVideoSubtitle/xwqVideoSubtitle/backend
mvn spring-boot:run
```

### 3. 测试发送验证码
```bash
curl -X POST http://localhost:8081/api/auth/forgot-password/send-code \
  -H "Content-Type: application/json" \
  -d '{"email":"your_email@example.com"}'
```

### 4. 查看邮箱
检查是否收到验证码邮件

### 5. 测试重置密码
```bash
curl -X POST http://localhost:8081/api/auth/forgot-password/reset \
  -H "Content-Type: application/json" \
  -d '{
    "email":"your_email@example.com",
    "code":"123456",
    "newPassword":"newpass123",
    "confirmPassword":"newpass123"
  }'
```

---

## 📝 API接口文档

### 1. 发送验证码

**接口**：`POST /api/auth/forgot-password/send-code`

**请求体**：
```json
{
  "email": "user@example.com"
}
```

**响应**：
```json
{
  "code": 200,
  "message": "验证码已发送到您的邮箱",
  "data": null,
  "timestamp": 1234567890
}
```

---

### 2. 重置密码

**接口**：`POST /api/auth/forgot-password/reset`

**请求体**：
```json
{
  "email": "user@example.com",
  "code": "123456",
  "newPassword": "newpass123",
  "confirmPassword": "newpass123"
}
```

**响应**：
```json
{
  "code": 200,
  "message": "密码重置成功",
  "data": null,
  "timestamp": 1234567890
}
```

---

## ⚠️ 常见问题

### 问题1：邮件发送失败
**原因**：
- 授权码错误（不是邮箱密码）
- SMTP服务未开启
- 防火墙阻止

**解决**：
1. 确认SMTP服务已开启
2. 使用正确的授权码
3. 检查端口是否被占用

### 问题2：验证码无效
**原因**：
- 验证码已过期（10分钟）
- 验证码已被使用
- 邮箱地址不匹配

**解决**：
1. 重新发送验证码
2. 确保输入的邮箱地址正确

### 问题3：邮箱未注册
**原因**：输入的邮箱未在系统中注册

**解决**：使用注册时的邮箱地址

---

## 🔒 安全建议

1. **验证码有效期**：10分钟（可调整）
2. **验证码长度**：6位数字
3. **重发间隔**：60秒
4. **密码强度**：至少6位
5. **使用次数**：验证码仅可使用一次

---

## 📧 邮件模板预览

邮件采用HTML格式，包含：
- 渐变色头部
- 大号验证码显示
- 安全提示
- 品牌标识
- 响应式设计

---

## 🎯 功能特性

✅ 6位随机数字验证码
✅ 10分钟有效期
✅ 精美的HTML邮件模板
✅ 60秒重发限制
✅ 验证码一次性使用
✅ 自动过期旧验证码
✅ 密码强度检测
✅ 友好的错误提示

---

**配置完成后，重启后端即可使用忘记密码功能！** 🎉
