# 音频提取失败故障排查指南

## 问题描述

字幕生成任务启动成功，但在音频提取阶段失败，错误信息：
```
java.lang.RuntimeException: 音频提取失败
```

## 排查步骤

### 1. 查看详细日志

重启后端服务，查看控制台日志：

```bash
cd backend
mvn spring-boot:run
```

查看日志中的关键信息：
- 视频文件路径
- 音频输出路径
- 具体的错误原因

### 2. 检查视频文件

#### 检查视频是否存在

```bash
# 查看上传的视频文件
ls -lh ./uploads/videos/
```

#### 检查视频格式

确保视频格式受支持：
- ✅ MP4
- ✅ AVI
- ✅ MKV
- ✅ MOV
- ✅ WMV
- ✅ FLV

#### 检查视频是否包含音频

使用ffmpeg检查：
```bash
ffmpeg -i /path/to/video.mp4
```

查看输出中是否有音频流：
```
Stream #0:1(und): Audio: aac (LC) (mp4a / 0x6134706D), 44100 Hz, stereo, fltp, 128 kb/s
```

如果没有音频流，说明视频本身没有音频，无法提取。

### 3. 检查目录权限

#### 检查上传目录

```bash
# 检查视频目录
ls -ld ./uploads/videos/

# 检查音频目录
ls -ld ./uploads/audio/

# 如果音频目录不存在，手动创建
mkdir -p ./uploads/audio/
chmod 755 ./uploads/audio/
```

#### 检查文件权限

```bash
# 给予写入权限
chmod -R 755 ./uploads/
```

### 4. 测试FFmpeg

#### 测试FFmpeg是否可用

```bash
# 检查ffmpeg版本
ffmpeg -version
```

#### 手动测试音频提取

```bash
# 使用ffmpeg手动提取音频
ffmpeg -i ./uploads/videos/1.mp4 -vn -acodec pcm_s16le -ar 16000 -ac 1 ./uploads/audio/test.wav
```

如果手动提取成功，说明FFmpeg工作正常。

### 5. 检查JavaCV库

#### 查看依赖

检查 `pom.xml` 中是否包含JavaCV依赖：

```xml
<dependency>
    <groupId>org.bytedeco</groupId>
    <artifactId>javacv-platform</artifactId>
    <version>1.5.9</version>
</dependency>
```

#### 测试音频提取功能

创建测试类：

```java
package com.subtitle.utils;

public class AudioExtractorTest {
    public static void main(String[] args) {
        String videoPath = "./uploads/videos/1.mp4";
        String audioPath = "./uploads/audio/test.wav";

        boolean hasAudio = AudioExtractor.hasAudio(videoPath);
        System.out.println("视频包含音频: " + hasAudio);

        if (hasAudio) {
            boolean success = AudioExtractor.extractAudio(videoPath, audioPath);
            System.out.println("音频提取结果: " + success);
        }
    }
}
```

### 6. 常见错误及解决方案

#### 错误1：视频文件不存在

**日志信息**：
```
视频文件不存在: /path/to/video.mp4
```

**解决方案**：
- 检查视频上传是否成功
- 检查数据库中存储的文件路径是否正确
- 检查配置文件中的 `app.video-path` 设置

#### 错误2：视频不包含音频流

**日志信息**：
```
视频中未找到音频流
```

**解决方案**：
- 使用包含音频的视频文件
- 或者先给视频添加音轨

```bash
# 添加静音音轨
ffmpeg -i video_no_audio.mp4 -f lavfi -i anullsrc=channel_layout=mono:sample_rate=16000 -shortest output_with_audio.mp4
```

#### 错误3：权限不足

**日志信息**：
```
无法创建文件: ./uploads/audio/1.wav (Permission denied)
```

**解决方案**：
```bash
chmod -R 755 ./uploads/
chown -R $USER:$USER ./uploads/
```

#### 错误4：FFmpeg库加载失败

**日志信息**：
```
java.lang.UnsatisfiedLinkError: no jnijavacv in java.library.path
```

**解决方案**：
- 确保javacv-platform依赖正确
- 检查系统架构（x86_64 vs arm64）
- 尝试重新下载依赖

```bash
mvn clean install
```

#### 错误5：内存不足

**日志信息**：
```
java.lang.OutOfMemoryError: Java heap space
```

**解决方案**：
- 增加JVM内存

```bash
mvn spring-boot:run -Dspring-boot.run.jvmArguments="-Xmx2g"
```

### 7. 临时调试方案

#### 使用命令行FFmpeg

修改 `AudioExtractor.java`，使用命令行方式：

```java
public static boolean extractAudioWithCommandLine(String videoPath, String audioPath) {
    try {
        ProcessBuilder pb = new ProcessBuilder(
            "ffmpeg",
            "-i", videoPath,
            "-vn",
            "-acodec", "pcm_s16le",
            "-ar", "16000",
            "-ac", "1",
            audioPath
        );
        pb.redirectErrorStream(true);
        Process process = pb.start();
        int exitCode = process.waitFor();

        return exitCode == 0;
    } catch (Exception e) {
        logger.error("命令行音频提取失败", e);
        return false;
    }
}
```

### 8. 检查数据库配置

#### 查看视频记录

```sql
SELECT id, title, file_path, format, status
FROM video
ORDER BY id DESC
LIMIT 1;
```

确认：
- file_path 是否正确
- 文件是否存在
- format 是否正确

### 9. 完整测试流程

```bash
# 1. 清理旧文件
rm -rf ./uploads/audio/*

# 2. 重启服务
mvn spring-boot:run

# 3. 上传测试视频
# 使用前端界面或API上传

# 4. 查看日志
tail -f logs/application.log | grep "音频提取"

# 5. 检查输出
ls -lh ./uploads/audio/
```

### 10. 提供调试信息

如果问题仍未解决，请提供：

1. **后端日志**
   ```bash
   tail -100 logs/application.log
   ```

2. **视频信息**
   ```bash
   ffmpeg -i ./uploads/videos/[your_video].mp4
   ```

3. **文件列表**
   ```bash
   ls -lhR ./uploads/
   ```

4. **系统信息**
   - 操作系统
   - Java版本
   - Maven版本
   - FFmpeg版本

## 预防措施

### 1. 视频上传时验证

在前端上传时检查视频是否包含音频：

```javascript
const video = document.createElement('video');
video.src = URL.createObjectURL(file);
video.onloadedmetadata = () => {
  // 检查是否有音轨
  if (video.mozHasAudio !== false) {
    // 允许上传
  }
};
```

### 2. 后端预检查

在字幕生成前检查视频：

```java
if (!AudioExtractor.hasAudio(video.getFilePath())) {
    return ApiResponse.error("视频不包含音频，无法生成字幕");
}
```

### 3. 错误处理优化

提供更友好的错误提示：

```java
try {
    String audioPath = extractAudio(video);
} catch (RuntimeException e) {
    if (e.getMessage().contains("不包含音频流")) {
        task.setMessage("视频没有音频，无法生成字幕");
    } else {
        task.setMessage("音频提取失败: " + e.getMessage());
    }
}
```

---

**更新时间**：2026-02-27
**相关文档**：字幕生成调试指南.md
