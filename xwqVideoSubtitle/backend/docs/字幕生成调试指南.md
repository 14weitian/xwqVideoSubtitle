# 字幕生成功能调试指南

## 问题：前端点击生成字幕无效

### 已修复的问题

✅ **TaskId不一致问题**：Controller和Service使用了不同的taskId，导致前端查询任务状态失败。已修复为使用同一个taskId。

### 需要检查的配置

#### 1. 配置智谱API密钥

**方式一：设置环境变量（推荐）**

```bash
# macOS/Linux
export ZHIPU_API_KEY="你的智谱API密钥"

# Windows CMD
set ZHIPU_API_KEY=你的智谱API密钥

# Windows PowerShell
$env:ZHIPU_API_KEY="你的智谱API密钥"
```

**方式二：直接修改配置文件**

编辑 `backend/src/main/resources/application.yml`：

```yaml
app:
  stt:
    provider: zhipu
    zhipu:
      api-key: "你的智谱API密钥"  # 替换 your_zhipu_api_key_here
```

#### 2. 获取智谱API密钥

1. 访问 [智谱AI开放平台](https://open.bigmodel.cn/)
2. 注册并登录
3. 进入控制台 → API Keys
4. 创建新的API密钥

#### 3. 检查API端点

智谱AI的语音转文字API端点可能需要确认：

- **当前配置**: `https://open.bigmodel.cn/api/paas/v4/audio/transcriptions`
- **备用端点**: `https://open.bigmodel.cn/api/paas/v4/chat/completions`

如果API调用失败，请检查智谱AI官方文档确认正确的端点。

### 测试步骤

#### 1. 启动后端服务

```bash
cd backend
mvn spring-boot:run
```

#### 2. 检查日志

启动时应该看到类似日志：

```
INFO: 使用智谱AI STT服务
```

如果看到错误：

```
No qualifying bean of type 'SttService'
```

说明SttService没有正确注入，检查：
- 配置文件中 `app.stt.provider` 是否设置为 `zhipu`
- ZhipuSttServiceImpl 类上的注解是否正确

#### 3. 测试字幕生成

1. 上传一个视频
2. 点击"生成字幕"按钮
3. 打开浏览器开发者工具（F12）
4. 查看 Network 标签页

**预期行为：**

- POST `/api/subtitles/generate` 返回 taskId
- GET `/api/subtitles/task/{taskId}` 返回任务状态
- 任务状态每2秒更新一次

**可能的错误：**

- **404**: API端点错误
- **401**: API密钥无效
- **500**: 服务器内部错误

#### 4. 查看后端日志

```bash
# 查看实时日志
tail -f logs/application.log

# 或在控制台查看
```

关键日志：

```
开始使用智谱AI GLM-ASR转写音频文件: /path/to/audio.wav
调用智谱AI API: https://open.bigmodel.cn/api/paas/v4/audio/transcriptions
智谱AI转写成功
解析到 X 个字幕片段
```

### 常见错误排查

#### 错误1：API密钥无效

```
ERROR: 401 Unauthorized
```

**解决方案**:
- 检查API密钥是否正确
- 确认API密钥已激活
- 检查账户余额

#### 错误2：API端点错误

```
ERROR: 404 Not Found
```

**解决方案**:
- 检查智谱AI官方文档
- 确认API端点URL
- 可能需要修改 `ZhipuSttConfig.java` 中的 endpoint

#### 错误3：音频文件提取失败

```
ERROR: 音频提取失败
```

**解决方案**:
- 确认视频文件格式支持（mp4, avi, mkv等）
- 检查FFmpeg是否正确安装
- 查看 `./uploads/audio/` 目录权限

#### 错误4：SttService注入失败

```
ERROR: No qualifying bean of type 'SttService'
```

**解决方案**:
- 检查 `app.stt.provider` 配置
- 确认ZhipuSttServiceImpl类有 `@Service` 注解
- 检查 `@ConditionalOnProperty` 条件

### 临时调试方案

如果智谱API暂时不可用，可以切换到其他STT服务：

#### 切换到Azure

```yaml
app:
  stt:
    provider: azure  # 修改为 azure
    azure:
      key: ${AZURE_SPEECH_KEY}
      region: ${AZURE_SPEECH_REGION}
```

#### 切换到OpenAI Whisper

```yaml
app:
  stt:
    provider: whisper  # 修改为 whisper
    whisper:
      api-key: ${OPENAI_API_KEY}
```

### 验证配置

创建测试接口验证配置：

```bash
# 测试配置是否正确
curl http://localhost:8081/api/actuator/health
```

### 需要帮助？

如果问题仍然存在，请提供：

1. 后端启动日志
2. 浏览器控制台错误信息
3. Network标签中的请求/响应详情
4. 后端日志中的错误堆栈

---

## 联系方式

- 智谱AI文档: https://docs.bigmodel.cn/
- 项目Issues: [GitHub Issues链接]
