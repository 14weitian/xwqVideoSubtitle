# 前端错误信息显示优化

## 改进内容

### 1. 后端改进

#### 自动设置errorMessage字段

修改了 `SubtitleService.java` 中的 `updateTaskStatus` 方法：

```java
private void updateTaskStatus(String taskId, int status, Integer progress, String message) {
    TaskRecord task = taskRecordMapper.selectByMap(
            Collections.singletonMap("task_id", taskId)).stream().findFirst().orElse(null);
    if (task != null) {
        task.setStatus(status);
        if (progress != null) {
            task.setProgress(progress);
        }
        task.setMessage(message);

        // 如果是失败状态，同时设置errorMessage
        if (status == 2) {
            task.setErrorMessage(message);
        }

        taskRecordMapper.updateById(task);
    }
}
```

**效果**：当任务失败时，会同时设置 `message` 和 `errorMessage` 字段，确保前端能获取到详细的错误信息。

### 2. 前端改进

#### 改进错误信息获取

修改了 `SubtitleDisplay.tsx` 中的错误处理逻辑：

```typescript
// 优先显示errorMessage，其次显示message
const errorMsg = task.errorMessage || task.message || '未知错误';
setTaskMessage(errorMsg);
```

#### 增强错误捕获

添加了对后端API错误响应的捕获：

```typescript
catch (error: any) {
  const errorMsg = error?.response?.data?.message || error?.message || '默认错误信息';
  setTaskMessage(errorMsg);
}
```

#### 改进UI显示

**错误提示框**：
```
┌──────────────────────────────────────────┐
│ ✕ 字幕生成失败                      ✕   │
│   java.lang.RuntimeException: 音频提取失败 │
└──────────────────────────────────────────┘
```

特性：
- ✅ 显示"字幕生成失败"标题
- ✅ 显示后端返回的详细错误信息
- ✅ 可手动关闭错误提示（点击X按钮）
- ✅ 错误提示不会自动消失

**成功提示框**：
```
┌──────────────────────────────────────────┐
│ ✓ 字幕生成完成！                          │
└──────────────────────────────────────────┘
```

特性：
- ✅ 绿色背景，成功图标
- ✅ 3秒后自动消失

**进度提示框**：
```
┌──────────────────────────────────────────┐
│ 字幕生成进度                    45%      │
│ ████████████░░░░░░░░░░░░░░░░░░░░░       │
│ 开始语音识别...                           │
└──────────────────────────────────────────┘
```

特性：
- ✅ 实时显示进度百分比
- ✅ 动画进度条
- ✅ 显示当前处理步骤的详细描述

## 错误信息展示示例

### 示例1：音频提取失败

**后端日志**：
```
ERROR: 视频文件不包含音频流
```

**前端显示**：
```
✕ 字幕生成失败
  视频文件不包含音频流
```

### 示例2：API密钥无效

**后端日志**：
```
ERROR: 401 Unauthorized - API密钥无效
```

**前端显示**：
```
✕ 字幕生成失败
  字幕生成失败: 401 Unauthorized - API密钥无效
```

### 示例3：网络错误

**前端显示**：
```
✕ 字幕生成失败
  网络请求失败，请检查网络连接
```

### 示例4：文件不存在

**后端日志**：
```
ERROR: 视频文件不存在: ./uploads/videos/1.mp4
```

**前端显示**：
```
✕ 字幕生成失败
  字幕生成失败: 视频文件不存在: ./uploads/videos/1.mp4
```

## 技术细节

### 后端错误传递流程

```
Service层异常
    ↓
updateTaskStatus(status=2, message="错误信息")
    ↓
设置 task.errorMessage = message
    ↓
保存到数据库
    ↓
前端查询 /subtitles/task/{taskId}
    ↓
返回 TaskRecord { errorMessage: "错误信息", ... }
    ↓
前端显示错误信息
```

### 前端错误处理逻辑

```typescript
// 1. 轮询查询任务状态
const task = await subtitleApi.getTaskStatus(taskId);

// 2. 判断任务状态
if (task.status === 2) { // 失败
    // 3. 优先使用errorMessage
    const errorMsg = task.errorMessage || task.message || '未知错误';
    setTaskMessage(errorMsg);
}

// 4. 捕获网络错误
catch (error: any) {
    // 5. 从多个来源获取错误信息
    const errorMsg =
        error?.response?.data?.message ||  // 后端API错误响应
        error?.message ||                   // JavaScript错误信息
        '默认错误信息';                      // 默认提示
    setTaskMessage(errorMsg);
}
```

## 用户体验优化

### 1. 错误信息可关闭

用户可以点击错误提示框右上角的X按钮手动关闭错误提示。

```typescript
<button
  onClick={() => {
    setTaskMessage('');
    setCurrentTaskId(null);
    setTaskProgress(0);
  }}
  className="text-red-600 hover:text-red-800 ml-2"
>
  <svg>...</svg>
</button>
```

### 2. 错误信息不自动消失

失败提示会一直显示，直到：
- 用户手动关闭
- 用户重新点击"生成字幕"按钮

这样用户有足够时间查看和记录错误信息。

### 3. 多层级错误信息获取

```
1. task.errorMessage        (优先级最高)
2. task.message             (次选)
3. error.response.data.message (API错误)
4. error.message            (JS错误)
5. 默认错误信息              (兜底)
```

确保在各种情况下都能显示有意义的错误信息。

## 测试场景

### 场景1：正常流程

1. 上传视频
2. 点击"生成字幕"
3. 观察进度条：10% → 30% → 80% → 95% → 100%
4. 看到成功提示："字幕生成完成！"
5. 3秒后提示自动消失

### 场景2：音频提取失败

1. 上传不含音频的视频
2. 点击"生成字幕"
3. 看到进度：10%
4. 显示错误："字幕生成失败 / 视频文件不包含音频流"
5. 错误提示一直显示
6. 可手动关闭

### 场景3：API密钥无效

1. 配置错误的智谱API密钥
2. 上传视频并生成字幕
3. 看到进度：10% → 30%
4. 显示错误："字幕生成失败 / 401 Unauthorized"
5. 提示用户检查API配置

### 场景4：网络错误

1. 断开网络连接
2. 点击"生成字幕"
3. 显示错误："网络请求失败，请检查网络连接"

## 相关文件

- `backend/src/main/java/com/subtitle/service/SubtitleService.java`
- `frontend/src/components/SubtitleDisplay.tsx`
- `backend/src/main/java/com/subtitle/entity/TaskRecord.java`

## 后续优化建议

1. **错误分类**：根据错误类型显示不同的图标和颜色
2. **错误建议**：针对常见错误提供解决方案
3. **错误日志**：在前端显示完整的错误堆栈（可选展开）
4. **重试机制**：对于网络错误，提供一键重试按钮
5. **错误上报**：将错误信息上报到监控系统

---

**更新时间**：2026-02-27
**版本**：v1.1.0
