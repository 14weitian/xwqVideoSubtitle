# 字幕生成进度显示功能

## 功能概述

在前端页面添加了实时进度条，用于展示字幕生成的进度状态。

## 功能特性

### ✅ 实时进度显示

- **进度条**：可视化展示字幕生成进度（0-100%）
- **进度消息**：显示当前处理步骤的详细描述
- **自动刷新**：每2秒自动更新任务状态

### ✅ 状态提示

#### 1. 生成中状态（蓝色）
```
┌─────────────────────────────────────┐
│ 字幕生成进度              45%      │
│ ████████████░░░░░░░░░░░░░░░░░░░░░ │
│ 开始语音识别...                      │
└─────────────────────────────────────┘
```

#### 2. 完成状态（绿色）
```
┌─────────────────────────────────────┐
│ ✓ 字幕生成完成！                     │
└─────────────────────────────────────┘
```

#### 3. 失败状态（红色）
```
┌─────────────────────────────────────┐
│ ✗ 生成失败: API密钥无效              │
└─────────────────────────────────────┘
```

### ✅ 交互改进

- **按钮状态**：生成中时按钮变灰并显示"生成中..."，防止重复点击
- **自动清除**：成功提示3秒后自动消失
- **错误保留**：失败提示会一直显示，直到用户重新尝试

## 进度阶段

字幕生成过程包含以下阶段：

| 进度 | 阶段 | 说明 |
|------|------|------|
| 0-10% | 开始提取音频 | 从视频文件中提取音频轨道 |
| 10-30% | 音频提取完成 | 准备调用语音识别服务 |
| 30-80% | 语音识别中 | 调用智谱AI API进行语音转文字 |
| 80-95% | 保存字幕 | 将识别结果保存到数据库 |
| 95-100% | 生成文件 | 生成SRT/VTT等格式的字幕文件 |

## 技术实现

### 前端组件

**文件**：`frontend/src/components/SubtitleDisplay.tsx`

**新增状态**：
```typescript
const [isGenerating, setIsGenerating] = useState(false);
const [taskProgress, setTaskProgress] = useState(0);
const [taskMessage, setTaskMessage] = useState('');
const [currentTaskId, setCurrentTaskId] = useState<string | null>(null);
```

**轮询机制**：
```typescript
const checkStatus = setInterval(async () => {
  const task = await subtitleApi.getTaskStatus(taskId);

  setTaskProgress(task.progress || 0);
  setTaskMessage(task.message || '处理中...');

  if (task.status === 1) { // 完成
    clearInterval(checkStatus);
    // ...
  }
}, 2000);
```

### 后端接口

**Controller**：`SubtitleController.java`

**Service**：`SubtitleService.java`

任务状态更新：
```java
updateTaskStatus(taskId, 0, 10, "开始提取音频");
updateTaskStatus(taskId, 0, 30, "开始语音识别");
updateTaskStatus(taskId, 0, 80, "保存字幕数据");
updateTaskStatus(taskId, 1, 100, "字幕生成完成");
```

## 样式设计

### 进度条颜色

- **背景色**：`bg-blue-200`（浅蓝色）
- **进度色**：`bg-blue-600`（深蓝色）
- **过渡动画**：`transition-all duration-500 ease-out`

### 提示框样式

#### 生成中（蓝色主题）
```css
bg-blue-50 border-blue-200
```

#### 完成（绿色主题）
```css
bg-green-50 border-green-200
```

#### 失败（红色主题）
```css
bg-red-50 border-red-200
```

## 使用示例

### 1. 上传视频

```
用户上传视频 → 视频出现在视频列表
```

### 2. 选择视频

```
点击视频列表中的视频 → 切换到字幕管理标签
```

### 3. 生成字幕

```
点击"生成字幕"按钮 → 显示进度条 → 实时更新进度 → 完成提示
```

### 4. 查看字幕

```
字幕生成完成后 → 自动显示在"已有字幕"列表 → 点击查看详情
```

## 错误处理

### 常见错误及提示

| 错误 | 提示信息 | 解决方案 |
|------|---------|---------|
| 视频不存在 | 生成失败: 视频不存在 | 重新上传视频 |
| 音频提取失败 | 生成失败: 音频提取失败 | 检查视频格式 |
| API密钥无效 | 生成失败: 401 Unauthorized | 配置正确的API密钥 |
| 网络超时 | 检查任务状态失败 | 检查网络连接 |

## 性能优化

### 轮询间隔

- **当前设置**：2秒
- **推荐范围**：1-3秒
- **权衡**：更短间隔更实时，但增加服务器负载

### 优化建议

1. **WebSocket实时推送**：替代轮询机制
2. **进度缓存**：避免频繁数据库查询
3. **取消任务**：添加取消生成功能

## 测试

### 手动测试步骤

1. 启动后端服务
2. 启动前端服务
3. 登录系统
4. 上传测试视频
5. 点击"生成字幕"
6. 观察进度条变化
7. 验证字幕生成成功

### 预期行为

- ✅ 进度条平滑增长
- ✅ 进度消息实时更新
- ✅ 完成后自动刷新字幕列表
- ✅ 失败时显示错误信息
- ✅ 按钮状态正确切换

## 后续改进

### 计划功能

- [ ] 添加取消任务按钮
- [ ] 显示预计剩余时间
- [ ] 支持多任务并行
- [ ] 任务历史记录
- [ ] 邮件通知完成

### UI改进

- [ ] 添加动画效果
- [ ] 暗色主题适配
- [ ] 移动端优化
- [ ] 进度详情弹窗

## 相关文档

- [智谱AI集成说明.md](./智谱AI集成说明.md)
- [字幕生成调试指南.md](./字幕生成调试指南.md)

---

**更新日期**：2026-02-27
**版本**：v1.0.0
